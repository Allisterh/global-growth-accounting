```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, magrittr)
```

# Fuentes del crecimiento económico: La productividad de los factores en el mundo

## (a) Per capita GDP growth rates by region

```{r}
regions <- read_csv("regions.csv")
```

```{r}
library(scales)

regions %>%
  mutate(pcap = y/pop,
         pcap_growth = ((pcap - lag(pcap) ) / pcap) * 100) %>% 
  filter(year >= 1985) %>%
  ggplot(aes(year, pcap_growth, 
             color = fct_reorder2(region, pcap_growth, desc(id)))) +
  geom_line(size = .5) +
  labs(title = "Crecimiento económico en el mundo",
       subtitle = "Tasas de crecimiento del ingreso per cápita",
       caption = "Penn World Table (v 10.0)") +
  scale_y_continuous(labels = comma, breaks = scales::pretty_breaks(n = 10)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  guides(color = guide_legend(nrow = 1)) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(
      face = "bold",
      hjust = .5,
      margin = margin(10, 0, 5, 0)
    ),
    plot.subtitle = element_text(hjust = .5, 
                                 margin = margin(0, 0, 15, 0)),
    plot.caption = element_text(color = "gray50", 
                                size = 8, 
                                margin = margin(15, 0, 0, 0)),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray95")
  )
```

```{r}
library(here)
ggsave(filename = here("Plots","Plot1.png"))
```

## (b) Solow decomposition function

```{r}
solow <- function(data, y, l, k, labsh) {
  data %>%
  mutate(
    # Logs of output, capital and labor
    y = log({{y}}),
    k = log({{k}}),
    l = log({{l}}),
    # First differences (growth rates)
    dy = ({{y}} - lag({{y}})) * 100,
    dk = ({{k}} - lag({{k}})) * 100,
    dl = ({{l}} - lag({{l}})) * 100,
    # Share of capital in the economy
    capsh = 1 - {{labsh}},
    # Contributions of factors in the output growth
    k_cont = dk * capsh,
    l_cont = dl * {{labsh}},
    tfp_cont = dy - k_cont - l_cont
  ) %>%
  na.omit()
}
```

## (c) Growth accounting for Guatemala

```{r}
gtm <- read_csv("guatemala.csv")
```

```{r}
library(scales)

gtm %>%
  solow(y = y,
        l = l,
        k = k,
        labsh = labsh) %>%
  select(country, year, k_cont, l_cont, tfp_cont) %>%
  pivot_longer(-c(country, year)) %>%
  ggplot(aes(year, value, fill = name)) +
  geom_col() +
  labs(title = "Contabilidad del crecimiento: Guatemala",
       subtitle = "Contribución de los factores productivos (1955 – 2019)",
       caption = "Datos: Penn World Table (v 10.0)") +
  guides(color = guide_legend(nrow = 1)) +
  scale_fill_discrete(name = "Contribución:",
                      labels = c("Capital", "Trabajo", "PTF")) +
  scale_y_continuous(labels = comma, breaks = scales::pretty_breaks(n = 10)) +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 15)) +
  guides(color = guide_legend(nrow = 1)) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(
      face = "bold",
      hjust = .5,
      margin = margin(10, 0, 5, 0)
    ),
    plot.subtitle = element_text(hjust = .5,
                                 margin = margin(0, 0, 15, 0)),
    plot.caption = element_text(
      color = "gray50",
      size = 8,
      margin = margin(15, 0, 0, 0)
    ),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray95")
  )
```

```{r}
ggsave(filename = here("Plots","Plot2.png"))
```

## (d) Average growth accounting by region

```{r}
regions %>%
  group_by(region) %>%
  filter(year %in% c(1984:2019)) %>%
  solow(y = y,
        l = l,
        k = k,
        labsh = labsh) %>%
  select(region, k_cont, l_cont, tfp_cont) %>%
  summarise_if(is.numeric, mean) %>%
  select(region, k_cont, l_cont, tfp_cont) %>%
  pivot_longer(-c(region)) %>%
  ggplot(aes(region, value, fill = name)) +
  geom_col() +
  labs(title = "Contabilidad del crecimiento a nivel mundial",
       subtitle = "Contribución de los factores productivos (1985 – 2019)",
       caption = "Datos: Penn World Table (v 10.0)") +
  guides(color = guide_legend(nrow = 1)) +
  scale_fill_discrete(name = "Contribución:",
                      labels = c("Capital", "Trabajo", "PTF")) +
  scale_y_continuous(labels = comma, breaks = scales::pretty_breaks(n = 5)) +
  guides(color = guide_legend(nrow = 1)) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    plot.title = element_text(
      face = "bold",
      hjust = .5,
      margin = margin(10, 0, 5, 0)
    ),
    plot.subtitle = element_text(hjust = .5,
                                 margin = margin(0, 0, 15, 0)),
    plot.caption = element_text(
      color = "gray50",
      size = 8,
      margin = margin(15, 0, 0, 0)
    ),
    legend.position = "bottom",
    legend.title = element_blank(),
    panel.background = element_rect(fill = "gray95")
  )
```

```{r}
ggsave(filename = here("Plots","Plot3.png"))
```

## (e) Cluster analysis

```{r}
countries <- read_csv("countries.csv")
```

```{r}
library(factoextra)

countries %<>%
  group_by(country) %>%
  filter(year %in% c(1984:2019)) %>%
  solow(y = y,
        l = l,
        k = k,
        labsh = labsh) %>%
  select(country, k_cont, l_cont, tfp_cont) %>%
  summarise_if(is.numeric, mean) %>%
  column_to_rownames("country") %>%
  scale()

set.seed(123)
cluster <- kmeans(scale(countries), 3, nstart = 25)

fviz_cluster(
  cluster,
  data = countries,
  palette = c("#00AFBB", "#2E9FDF", "#E7B800", "#FC4E07"),
  main = "Partitioning Clustering Plot"
)
```
