---
---
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse, magrittr)
```

```{r data, message=FALSE, warning=FALSE, include=FALSE}
growth <- read_csv("countries_growth.csv")
poverty <- read_csv("countries_poverty.csv")
data <- growth %>% left_join(poverty)
```

## Metodología

```{r solow, message=FALSE, warning=FALSE, include=FALSE}
solow <- function(data, y, l, k, labsh) {
  data %>%
  mutate(
    # Logs of output, capital and labor
    y = log({{y}}),
    k = log({{k}}),
    l = log({{l}}),
    # First differences (growth rates)
    dy = ({{y}} - lag({{y}})) * 100,
    dk = ({{k}} - lag({{k}})) * 100,
    dl = ({{l}} - lag({{l}})) * 100,
    # Share of capital in the economy
    capsh = 1 - {{labsh}},
    # Contributions of factors in the output growth
    k_cont = dk * capsh,
    l_cont = dl * {{labsh}},
    tfp_cont = dy - k_cont - l_cont
  ) %>%
  na.omit()
}

data_solow <- 
  data %>%
  group_by(country) %>%
  solow(y = y,
        l = l,
        k = k,
        labsh = labsh) %>% 
  select(country:year, dy, k_cont, l_cont, tfp_cont, pov) %>% 
  ungroup()
```

### Simple regression models

```{r, message=FALSE, warning=FALSE, include=FALSE}
pacman::p_load(panelr, plm, broom, stargazer)
```

```{r estimation, message=FALSE, warning=FALSE, include=FALSE}

# Subset
data85 <- data_solow %>% filter(year == 1985)
data19 <- data_solow %>% filter(year == 2019)

# Simple regression models:
m1 <- data85 %>% lm(pov ~ k_cont + l_cont + tfp_cont, data = . ) 
m2 <- data19 %>% lm(pov ~ k_cont + l_cont + tfp_cont, data = . )

# «Before and after» comparisons:
# Compute the differences
diff_pov <- data19$pov - data85$pov
diff_k <- data19$k_cont - data85$k_cont
diff_l <- data19$l_cont - data85$l_cont
diff_tfp <- data19$tfp_cont - data85$tfp_cont

# Regression with differenced data
m3 <- lm(diff_pov ~ diff_k + diff_l + diff_tfp)

# Panel data
panel  <-  panel_data(data_solow, id = country, wave = year)

# Fixed effects
m4 <- plm(pov ~ k_cont + l_cont + tfp_cont,
          data = panel,
          index = c("country", "year"),
          model = "within")

# Fixed effects
m5 <- plm(pov ~ k_cont + l_cont + tfp_cont,
          data = panel,
          index = c("country", "year"),
          model = "within",
          effect = "twoways")
```

```{r chart, message=FALSE, warning=FALSE, include=FALSE}
# Gather clustered standard errors in a list
rob_se <- list(sqrt(diag(vcovHC(m1, type = "HC1"))),
               sqrt(diag(vcovHC(m2, type = "HC1"))),
               sqrt(diag(vcovHC(m3, type = "HC1"))),
               sqrt(diag(vcovHC(m4, type = "HC1"))),
               sqrt(diag(vcovHC(m5, type = "HC1"))))
```

```{r, results='asis'}
stargazer(m1, m2, m3, m4, m5, 
          digits = 3,
          header = FALSE,
          type = "html", 
          se = rob_se,
          title = "Test",
          model.numbers = FALSE,
          column.labels = c("(1)", "(2)", "(3)", "(4)", "(5)"),
          out = "models.htm")
```
